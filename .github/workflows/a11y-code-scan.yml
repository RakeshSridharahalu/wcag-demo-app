name: "WCAG Accessibility â€” Code Scan"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  wcag-code-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
    # Check out code
    - uses: actions/checkout@v4

    # Setup Node
    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # Install deps
    - name: Install dependencies
      run: npm ci

    # ---- Install Playwright Browsers (IMPORTANT) ----
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    # ---- STATIC WCAG SCAN (ESLint) ----
    - name: Run WCAG Static Scan (ESLint)
      run: npm run a11y:lint

    # ---- RUNTIME WCAG SCAN (Playwright + Axe) ----
    - name: Run Runtime WCAG Scan (Axe + Playwright)
      run: npm run a11y:runtime

    # ---- Upload static ESLint report BEFORE converting ----
    - name: Upload Static WCAG Report
      uses: actions/upload-artifact@v4
      with:
        name: wcag-static-report
        path: reports/eslint-a11y.json

    # ---- Upload runtime Axe report ----
    - name: Upload Runtime WCAG Report
      uses: actions/upload-artifact@v4
      with:
        name: wcag-runtime-report
        path: reports/axe-runtime.json

    # ---- Convert ESLint JSON to GitHub annotations ----
    - name: Convert report to GitHub annotations
      run: npm run a11y:report

    # ---- Create GitHub PR Annotation + Summary ----
    - name: Create GitHub PR annotations
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require("fs");
          const path = "reports/eslint-annotations.json";

          if (!fs.existsSync(path)) {
            console.log("No annotations file found.");
            return;
          }

          const data = JSON.parse(fs.readFileSync(path, "utf8"));
          const conclusion = data.errorCount > 0 ? "failure" : "success";

          // Create PR check
          await github.rest.checks.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: "WCAG Code Scan",
            head_sha: context.sha,
            status: "completed",
            conclusion,
            output: {
              title: "WCAG Accessibility Code Scan",
              summary: `Errors: ${data.errorCount} | Warnings: ${data.warningCount}`,
              annotations: data.annotations.slice(0, 50)
            }
          });

          // Comment on the PR
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `### WCAG Accessibility Code Scan  
            **Errors:** ${data.errorCount}  
            **Warnings:** ${data.warningCount}  
            Check the annotations tab for detailed line-by-line WCAG issues.`
          });
