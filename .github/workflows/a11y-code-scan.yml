name: "WCAG Accessibility â€” Code Scan"

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  wcag-code-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install dependencies
      run: npm ci

    - name: Ensure reports folder exists
      run: mkdir -p reports

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run WCAG Static Scan
      run: npm run a11y:lint

    - name: Run Runtime WCAG Scan
      run: npx vite build && npx vite preview --port 5173 --host & sleep 4 && node scripts/axe-playwright.js
    - name: Upload Static WCAG Report
      uses: actions/upload-artifact@v4
      with:
        name: wcag-static-report
        path: reports/eslint-a11y.json

    - name: Upload Runtime WCAG Report
      uses: actions/upload-artifact@v4
      with:
        name: wcag-runtime-report
        path: reports/axe-runtime.json

    - name: Convert to Annotations
      run: npm run a11y:report

    - name: Create GitHub PR annotations
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require("fs");
          const data = JSON.parse(fs.readFileSync("reports/eslint-annotations.json","utf8"));
          const conclusion = data.errorCount > 0 ? "failure" : "success";

          await github.rest.checks.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: "WCAG Code Scan",
            head_sha: context.sha,
            status: "completed",
            conclusion,
            output: {
              title: "WCAG Accessibility Code Scan",
              summary: `Errors: ${data.errorCount} | Warnings: ${data.warningCount}`,
              annotations: data.annotations.slice(0, 50)
            }
          });
